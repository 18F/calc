{% extends "base.html" %}
{% load staticfiles %}

{% block head %}
<script src="{% static 'hourglass_site/js/vendor/jquery.auto-complete.min.js' %}"></script>
{% endblock %}

{% block body %}
<style scoped>

  thead th {
    vertical-align: bottom;
  }

  * h5 {
    margin: 0 !important;
  }

  .container {
    margin-top: 2rem;
  }

  #search {
    position: relative;
  }

  #price {
    width: 8em;
  }

  .filters {
    background: #f9f9f9;
    padding: 1rem;
    border-radius: 4px;
  }

  .graphs {
    padding: 1rem 0;
  }

  .filters .filter {
    width: 50%;
    float: left;
  }

  th.column-labor_category {        width: 25%; }
  th.column-education_level {       width: 10%; }
  th.column-min_years_experience {  width: 10%; }
  th.column-wage {                  width:  8%; }
  th.column-idv_piid {              width: 12%; }
  th.column-vendor_name {           width: 35%; }

  td.column-idv_piid {
    white-space: nowrap;
  }

  #export-data {
    position: absolute;
    right: 0;
  }

</style>
<div class="container">
  <h1>Hourglass</h1>
  <form id="search" class="search" role="form">
    <div id="primary" class="row">
      <div class="six columns">
        <input id="labor_category" name="q" placeholder="Type a labor category" class="search u-full-width" type="text">
      </div>
      <div class="six columns">
        <button class="submit button-primary">Search</button>
      </div>
    </div>

    <!-- <h2>Filters</h2> -->

    <div class="config row">
      <div class="filters six columns">
        <h5>Filters</h5>
        <div class="filter">
          <label for="price">Price:</label>
          <input id="price" name="price" type="number" size="8" min="0" max="1000" step=".01" placeholder="all prices">
        </div>

        <div class="filter">
          <label for="site">Worksite:</label>
          <select id="site" name="site">
            <option value="">(all)</option>
            <option>customer</option>
            <option>contractor</option>
            <option>both</option>
          </select>
        </div>

        <!--
        <div class="filter">
          <label for="schedule">Schedule:</label>
          <select id="schedule" name="schedule">
            <option value="">(all)</option>
            <option>Environmental</option>
            <option>AIMS</option>
            <option>Logistics</option>
            <option>Language Services</option>
            <option>PES</option>
            <option>MOBIS</option>
            <option>Consolidated</option>
          </select>
        </div>
        -->

        <div class="filter">
          <label for="min_education">Min. Education Level:</label>
          <select id="min_education" name="min_education">
            <option value="">(none)</option>
            <option value="HS">High School</option>
            <option value="AA">Associates</option>
            <option value="BA">Bachelors Degree</option>
            <option value="MA">Masters Degree</option>
            <option value="PHD">Ph.D</option>
          </select>
        </div>

        <div class="filter">
          <label for="min_experience">Min. Experience:</label>
          <input id="min_experience" name="min_experience" type="number" min="0" max="50" step="1" placeholder="0">
          years
        </div>

        <div class="filter">
          <label for="business_size">Business Size:</label>
          <select id="business_size" name="business_size">
            <option value="">(all)</option>
            <option value="s">Small Business</option>
            <option value="o">Other than Small</option>
          </select>
        </div>

        <!--
        <div class="filter">
          <label for="fiscal_year">Fiscal Year:</label>
          <select id="fiscal_year" name="fiscal_year">
          </select>
        </div>
        -->

      </div><!-- /.filters  -->

      <div class="graphs six columns">
        <h5>Price Stats</h5>

        <div class="loading-indicator">
          <p class="message">Loading results...</p>
          <div class="error"></div>
        </div>

        <div class="graph">

          <svg id="price-histogram" class="histogram has-data">
          </svg>

          <!--
          <div id="price-range" class="range-graph has-data">
            <span class="tick min left">
              $<b class="value"></b><br>low
            </span>
            <span class="tick max right">
              $<b class="value"></b><br>high
            </span>
            <span class="tick average mark" style="left: 0%">
              average<br>
              $<b class="value"></b>
            </span>
          </div>
          -->

        </div>

        <!--
        <div class="graph">
          <div id="hourly-wages" class="bar-chart">
          </div>
        </div>
        -->

      </div><!-- /.graphs -->

    </div><!-- /.row -->

    <table id="results-table" class="results has-data">
      <caption>
        <span id="results-total">...</span> matching row(s), showing <span id="results-count">...</span>
        <a id="export-data" class="button" href="/api/rates/csv/">Export Data</a>
      </caption>
      <thead>
        <tr>
          <th data-key="labor_category">Labor Category</th>
          <th data-key="education_level">Minimum Education</th>
          <th data-key="min_years_experience">Minimum Experience</th>
          <th data-key="current_price" data-format="$%,.02f">Price</th>
          <th data-key="idv_piid">Contract #</th>
          <th data-key="vendor_name">Vendor</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

  </form>

</div>

<script>
(function(exports) {

  var form = d3.select("#search"),
      inputs = form.selectAll("*[name]"),
      formatPrice = d3.format(",.02f"),
      formatCommas = d3.format(","),
      api = new hourglass.API(),
      $search = $("#labor_category"),
      resultsTable = d3.select("#results-table")
        .style("display", "none"),
      loadingIndicator = form.select(".loading-indicator"),
      request;

  form.on("submit", function onsubmit() {
    // stop the form from submitting
    d3.event.preventDefault();
    submit(true);
  });

  inputs.on("change", function onchange() {
    submit(true);
  });

  initialize();

  window.addEventListener("popstate", popstate);

  function popstate() {
    // read the query string and set values accordingly
    var data = hourglass.qs.parse(location.search);
    inputs.on("change", null);
    setFormData(data);
    inputs.on("change", function onchange() {
      submit(true);
    });
    submit(false);
  }

  function initialize() {
    popstate();

    var autoCompReq;
    $search.autoComplete({
      minChars: 2,
      delay: 5,
      cache: true,
      source: function(term, done) {
        // console.log("search:", term);
        if (autoCompReq) autoCompReq.abort();
        autoCompReq = api.get({
          uri: "search",
          data: {q: term},
        }, function(error, result) {
          autoCompReq = null;
          if (error) return done([]);
          var categories = result.slice(0, 20).map(function(d) {
            return {
              term: d.labor_category,
              count: d.count
            };
          });
          return done(categories);
        });
      },
      renderItem: function(item, search) {
        var re = new RegExp("(" + search.split(" ").join("|") + ")", "gi"),
            term = item.term || item;
        return [
          '<div class="autocomplete-suggestion" data-val="' + term + '">',
            '<span class="term">', term.replace(re, "<b>$1</b>"), '</span>',
            '<span class="count">', item.count, '</span>',
          '</div>'
        ].join("");
      }
    });
  }

  var loadingTimeout;
  function submit(pushState) {
    var data = getFormData();
    console.log("submitting:", data);

    form.classed("loaded", false);
    clearTimeout(loadingTimeout);
    loadingTimeout = setTimeout(function() {
      form.classed("loading", true);
    }, 100);

    // cancel the outbound request if there is one
    if (request) request.abort();
    var defaults = {
      histogram: 10
    };
    request = api.get({
      uri: "rates", 
      data: hourglass.extend(defaults, data)
    }, update);


    d3.select("#export-data")
      .attr("href", function() {
        return [
          this.href.split("?").shift(),
          hourglass.qs.format(data)
        ].join("?");
      });

    if (pushState) {
      var href = "?" + hourglass.qs.format(data)
      history.pushState(null, null, href);
    }
  }

  function update(error, data) {
    clearTimeout(loadingTimeout);
    form.classed("loading", false);
    request = null;

    if (error) {
      form.classed("error", true);

      loadingIndicator.select(".error")
        .text(error.responseText);

      // ignore aborts
      if (error.statusText === "abort") {
        return;
      } else {
        console.warn("error:", error);
        return showError("Whoops: " + error.responseText);
      }
    }

    console.log("update:", data);
    form.classed("loaded", true);

    d3.select("#results-total")
      .text(data ? formatCommas(data.count) : "(none)");

    if (data && data.results && data.results.length) {
      updatePriceRange(data);
      updatePriceHistogram(data);
      // updateHourlyWages(data.hourly_wage_stats, [data.minimum, data.maximum]);
      updateResults(data.results || []);
    } else {
      data = EMPTY_DATA;
      updatePriceRange(EMPTY_DATA);
      updatePriceHistogram(EMPTY_DATA);
      // updateHourlyWages([], [0, 0]);
      updateResults([]);
    }
  }

  function updatePriceRange(data) {
    var priceScale = d3.scale.linear()
      .domain([data.minimum, data.maximum])
      .range([0, 100]);

    var graph = d3.select("#price-range");

    graph.select(".min")
      .call(setPrice, data.minimum);
    graph.select(".max")
      .call(setPrice, data.maximum);
    graph.select(".average")
      .call(setPrice, data.average)
      .style("left", priceScale(data.average) + "%");

    function setPrice(selection, price) {
      selection.select(".value")
        .text(formatPrice(+price));
    }
  }

  var histogramUpdated = false,
      EMPTY_DATA = {
        minimum: 0,
        maximum: 100,
        average: 50,
        wage_histogram: [
          {count: 0, min: 0, max: 50},
          {count: 0, min: 50, max: 1}
        ]
      };
  function updatePriceHistogram(data) {
    var width = 500,
        height = 200,
        pad = [30, 15, 50, 45],
        top = pad[0],
        left = pad[3],
        right = width - pad[1],
        bottom = height - pad[2],
        svg = d3.select("#price-histogram")
          .attr("viewBox", [0, 0, width, height].join(" ")),
        formatDecimal = d3.format(".02f"),
        formatDollars = function(n) {
          return "$" + formatDecimal(n);
        };

    var extent = [data.minimum, data.maximum],
        bins = data.wage_histogram,
        x = d3.scale.linear()
          .domain(extent)
          .range([left, right]),
        height = d3.scale.linear()
          .domain(d3.extent(bins, function(d) { return d.count; }))
          .range([0, bottom - top]);

    var xAxis = svg.select(".axis.x");
    if (xAxis.empty()) {
      xAxis = svg.append("g")
        .attr("class", "axis x");
    }

    var yAxis = svg.select(".axis.y");
    if (yAxis.empty()) {
      yAxis = svg.append("g")
        .attr("class", "axis y");
    }

    var gBar = svg.select("g.bars");
    if (gBar.empty()) {
      gBar = svg.append("g")
        .attr("class", "bars");
    }

    var avg = svg.select("g.avg");
    if (avg.empty()) {
      avg = svg.append("g")
        .attr("class", "avg");
      avg.append("text")
        .attr("text-anchor", "middle")
        .attr("dy", -10)
        .html('<tspan class="value"></tspan> average');
      avg.append("line");
      avg.append("circle")
        .attr("cy", -4)
        .attr("r", 3);
    }

    avg.select("line")
      .attr("y1", -4)
      .attr("y2", bottom - top + 8); // XXX tick size = 6
    avg.select(".value")
      .text(formatDollars(data.average));

    var bars = gBar.selectAll(".bar")
      .data(bins);

    bars.exit().remove();

    var enter = bars.enter().append("g")
      .attr("class", "bar");
    enter.append("title");

    var step = (right - left) / bins.length;
    enter.append("rect")
      .attr("x", function(d, i) {
        return left + i * step;
      })
      .attr("y", bottom)
      .attr("width", step)
      .attr("height", 0);

    bars.select("title")
      .text(function(d, i) {
        var inclusive = (i === bins.length - 1),
            sign = inclusive ? "<=" : "<";
        return [formatCommas(d.count), ":", formatDollars(d.min), "<= x " + sign, formatDollars(d.max)].join(" ");
      });

    var t = histogramUpdated
      ? svg.transition().duration(500)
      : svg;

    t.select(".avg")
      .attr("transform", "translate(" + [~~x(data.average), top] + ")");

    t.selectAll(".bar")
      .each(function(d) {
        d.x = x(d.min);
        d.width = x(d.max) - d.x;
        d.height = height(d.count);
        d.y = bottom - d.height;
      })
      .select("rect")
        .attr("x", function(d, i) { return d.x; })
        .attr("y", function(d, i) { return d.y; })
        .attr("height", function(d, i) { return d.height; })
        .attr("width", function(d, i) { return d.width; });

    var ticks = bins.map(function(d) { return d.min; })
      .concat([data.maximum]);

    var xa = d3.svg.axis()
      .orient("bottom")
      .scale(x)
      .tickValues(ticks)
      .tickFormat(function(d, i) {
        return (i === 0 || i === bins.length)
          ? formatDollars(d)
          : formatDecimal(d);
      });
    xAxis.call(xa)
      .attr("transform", "translate(" + [0, bottom + 2] + ")")
      .selectAll(".tick")
        .classed("primary", function(d, i) {
          return i === 0 || i === bins.length;
        })
        .select("text")
          .attr("text-anchor", "end")
          .attr("transform", "translate(-20,16) rotate(-45)");

    var ya = d3.svg.axis()
      .orient("left")
      .scale(d3.scale.linear()
        .domain(height.domain())
        .range([bottom, top]))
      .tickValues(height.domain());
    ya.tickFormat(formatCommas);
    yAxis.call(ya)
      .attr("transform", "translate(" + [left - 2, 0] + ")");

    histogramUpdated = true;
  }

  function updateHourlyWages(stats, domain) {
    var graph = d3.select("#hourly-wages"),
        row = graph.selectAll(".row")
          .data(stats, function(d) {
            return d.min_years_experience;
          });

    row.exit().remove();

    var enter = row.enter().append("div")
      .attr("class", "row");

    enter.append("span")
      .attr("class", "row-label years");

    var bar = enter.append("div")
      .attr("class", "bar")
      .style({
        "margin-left": "0%",
        "margin-right": "0%"
      });
    bar.append("span")
      .attr("class", "average")
      .style("left", "0%")
      .append("span")
        .attr("class", "label")
        .html('$<b class="value"></b><i class="count"></i>');

    var wageScale = d3.scale.linear()
      .domain(domain)
      .range([0, 100]);

    row.select(".years")
      .text(function(d) {
        return d.min_years_experience;
      });

    var bar = row.select(".bar")
      .style("margin-left", function(d) {
        return wageScale(d.min_wage) + "%";
      })
      .style("margin-right", function(d) {
        return wageScale(d.max_wage) + "%";
      });

    var avg = bar.select(".average")
      .style("left", function(d) {
        return wageScale(d.average_wage) + "%";
      });
    avg.select(".value")
      .text(function(d) {
        return d.average_wage;
      });
    avg.select(".count")
      .text(function(d) {
        return d.num_contracts;
      });
  }

  function updateResults(results) {
    d3.select("#results-count")
      .text(formatCommas(results.length));

    resultsTable.style("display", null);

    var thead = resultsTable
          .select("thead"),
        columns = thead.selectAll("th")
          .datum(function() {
            return {
              key: this.getAttribute("data-key"),
              format: getFormat(this.getAttribute("data-format"))
            };
          })
          .each(function(d) {
            this.classList.add("column-" + d.key);
          })
          .data(),
        tbody = resultsTable.select("tbody");

    var tr = tbody.selectAll("tr")
      .data(results);

    tr.exit().remove();
    tr.enter().append("tr")
      .selectAll("td")
        .data(columns)
        .enter()
        .append("td")
          .attr("class", function(column) {
            return "column-" + column.key;
          });

    tr.selectAll("td")
      .data(function(d) {
        return columns.map(function(column) {
          var key = column.key,
              value = d[key];
          return {
            column: column,
            row: d,
            key: key,
            value: value,
            string: column.format(value)
          };
        });
      })
      .text(function(d) { return d.string; });
  }

  function getFormData() {
    var data = {};
    inputs.each(function() {
      switch (this.type) {
        case "checkbox":
          if (!this.checked) return;
          break;
      }
      if (this.disabled || this.value === "") return;
      data[this.name] = this.value;
    });
    return data;
  }

  function setFormData(data) {
    if (!data) return;
    inputs.each(function() {
      if (data.hasOwnProperty(this.name)) {
        switch (this.type) {
          case "checkbox":
            this.checked = data[this.name] == this.value;
            return;
        }
        this.value = data[this.name];
      }
    });
  }

  function showError(error) {
    alert(error);
  }

  function getFormat(spec) {
    if (!spec) return function(d) { return d; };

    var index = spec.indexOf("%");
    if (index === -1) {
      return d3.format(spec);
    }
    var prefix = spec.substr(0, index),
        format = d3.format(spec.substr(index + 1));
    return function(str) {
      if (!str) return "";
      return prefix + format(+str);
    };
  }

})(this);
</script>

{% endblock %}
