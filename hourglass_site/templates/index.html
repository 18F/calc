{% extends "base.html" %}

{% block body %}
<style scoped>
  div.primary {
    position: relative;
  }

  #permalink {
    position: absolute;
    right: 0;
  }

  thead th {
    vertical-align: bottom;
  }

  th.column-labor_category {        width: 25%; }
  th.column-education_level {       width: 10%; }
  th.column-min_years_experience {  width: 10%; }
  th.column-wage {                  width:  8%; }
  th.column-idv_piid {              width: 12%; }
  th.column-vendor_name {           width: 35%; }

  td.column-idv_piid {
    white-space: nowrap;
  }
</style>
<div class="container">
  <form id="search" class="search" role="form">
    <h1 class="full-width">Search</h1>

    <div class="primary">
      <input id="labor_category" name="q" placeholder="Type a labor category" class="search" type="text">
      <button class="submit">Search</button>
      <a id="permalink">&infin; permalink</a>
    </div>

    <h2 class="full-width">Filters</h2>

    <div class="filters">

      <div class="filter">
        <label for="price">Price:</label>
        <input id="price" name="price" type="number" min="0" max="1000" step="10" placeholder="suggest an average $?">
      </div>

      <div class="filter">
        <label for="site">Worksite:</label>
        <select id="site" name="site">
          <option value="">(all)</option>
          <option>customer</option>
          <option>contractor</option>
          <option>both</option>
        </select>
      </div>

      <!--
      <div class="filter">
        <label for="schedule">Schedule:</label>
        <select id="schedule" name="schedule">
          <option value="">(all)</option>
          <option>Environmental</option>
          <option>AIMS</option>
          <option>Logistics</option>
          <option>Language Services</option>
          <option>PES</option>
          <option>MOBIS</option>
          <option>Consolidated</option>
        </select>
      </div>
      -->

      <div class="filter">
        <label for="min_education">Minimum Education Level:</label>
        <select id="min_education" name="min_education">
          <option value="">(none)</option>
          <option value="BA">Bachelors Degree</option>
          <option value="MA">Masters Degree</option>
          <option value="PHD">Ph.D</option>
        </select>
      </div>

      <div class="filter">
        <label for="min_experience">Minimum Years of Experience:</label>
        <input id="min_experience" name="min_experience" type="number" min="0" max="50" step="1" placeholder="suggest average?">
      </div>

      <!--
      <div class="filter">
        <label for="fiscal_year">Fiscal Year:</label>
        <select id="fiscal_year" name="fiscal_year">
        </select>
      </div>
      -->

    </div>

    <div class="graph">
      <div id="price-range" class="range-graph">
        <span class="tick min left">
          low: $<b class="value"></b>
        </span>
        <span class="tick max left">
          high: $<b class="value"></b>
        </span>
        <span class="tick average mark" style="top: 100%">
          $<b class="value"></b> average
        </span>
      </div>
    </div>

    <!--
    <div class="graph">
      <h6 class="title">Wages for years of experience</h6>
      <div id="hourly-wages" class="bar-chart">
      </div>
    </div>
    -->

  </form>

  <table id="results-table" class="results">
    <caption>
      <span id="results-total">...</span> matching rows (showing <span id="results-count">...</span>)
    </caption>
    <thead>
      <tr>
        <th data-key="labor_category">Labor Category</th>
        <th data-key="education_level">Minimum Education</th>
        <th data-key="min_years_experience">Minimum Experience</th>
        <th class="wage" data-format="$%,.02f">Price</th>
        <th data-key="idv_piid">Contract #</th>
        <th data-key="vendor_name">Vendor</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<script>
(function(exports) {

  var form = d3.select("#search"),
      inputs = form.selectAll("*[name]"),
      formatPrice = d3.format(",.02f"),
      formatCommas = d3.format(","),
      permalink = d3.select("#permalink"),
      api = new hourglass.API(),
      wageKey = "hourly_rate_year1",
      request;

  d3.select("th.wage")
    .attr("data-key", wageKey);

  form.on("submit", function onsubmit() {
    // stop the form from submitting
    d3.event.preventDefault();
    submit();
  });

  inputs.on("change", submit);

  initialize();

  function initialize() {
    // read the query string and set values accordingly
    var data = hourglass.qs.parse(location.search);
    setFormData(data);
    submit();
  }

  function submit() {
    var data = getFormData();
    console.log("submitting:", data);

    form.classed("loading", true);

    // cancel the outbound request if there is one
    if (request) request.abort();
    request = api.get({
      uri: "rates", 
      data: data
    }, update);

    permalink.attr("href", "?" + $.param(data));
  }

  function update(error, data) {
    form.classed("loading", false);
    request = null;

    if (error) {
      // ignore aborts
      if (error.statusText === "abort") {
        return;
      } else {
        console.warn("error:", error);
        return showError("Whoops: " + error.responseText);
      }
    }

    console.log("update:", data);

    d3.select("#results-total")
      .text(data ? formatCommas(data.count) : "(none)");

    if (data) {
      updatePrices(data);
      // updateHourlyWages(data.hourly_wage_stats, [data.minimum, data.maximum]);
      updateResults(data.results);
    } else {
      updatePrices({minimum: 0, maximum: 1, average: 0});
      // updateHourlyWages([], [0, 0]);
      updateResults([]);
    }
  }

  function updatePrices(data) {
    var priceScale = d3.scale.linear()
      .domain([data.maximum, data.minimum])
      .range([0, 100]);

    var graph = d3.select("#price-range");

    graph.select(".min")
      .call(setPrice, data.minimum);
    graph.select(".max")
      .call(setPrice, data.maximum);
    graph.select(".average")
      .call(setPrice, data.average)
      .style("top", priceScale(data.average) + "%");

    function setPrice(selection, price) {
      selection.select(".value")
        .text(formatPrice(+price));
    }
  }

  function updateHourlyWages(stats, domain) {
    var graph = d3.select("#hourly-wages"),
        row = graph.selectAll(".row")
          .data(stats, function(d) {
            return d.min_years_experience;
          });

    row.exit().remove();

    var enter = row.enter().append("div")
      .attr("class", "row");

    enter.append("span")
      .attr("class", "row-label years");

    var bar = enter.append("div")
      .attr("class", "bar")
      .style({
        "margin-left": "0%",
        "margin-right": "0%"
      });
    bar.append("span")
      .attr("class", "average")
      .style("left", "0%")
      .append("span")
        .attr("class", "label")
        .html('$<b class="value"></b><i class="count"></i>');

    var wageScale = d3.scale.linear()
      .domain(domain)
      .range([0, 100]);

    row.select(".years")
      .text(function(d) {
        return d.min_years_experience;
      });

    var bar = row.select(".bar")
      .style("margin-left", function(d) {
        return wageScale(d.min_wage) + "%";
      })
      .style("margin-right", function(d) {
        return wageScale(d.max_wage) + "%";
      });

    var avg = bar.select(".average")
      .style("left", function(d) {
        return wageScale(d.average_wage) + "%";
      });
    avg.select(".value")
      .text(function(d) {
        return d.average_wage;
      });
    avg.select(".count")
      .text(function(d) {
        return d.num_contracts;
      });
  }

  function updateResults(results) {
    d3.select("#results-count")
      .text(formatCommas(results.length));

    /*
    results.sort(function(a, b) {
      return d3.descending(+a[wageKey], +b[wageKey]);
    });
    */

    var table = d3.select("#results-table"),
        thead = table.select("thead"),
        columns = thead.selectAll("th")
          .datum(function() {
            return {
              key: this.getAttribute("data-key"),
              format: getFormat(this.getAttribute("data-format"))
            };
          })
          .each(function(d) {
            this.classList.add("column-" + d.key);
          })
          .data(),
        tbody = table.select("tbody");

    var tr = tbody.selectAll("tr")
      .data(results);

    tr.exit().remove();
    tr.enter().append("tr")
      .selectAll("td")
        .data(columns)
        .enter()
        .append("td")
          .attr("class", function(column) {
            return "column-" + column.key;
          });

    tr.selectAll("td")
      .data(function(d) {
        return columns.map(function(column) {
          var key = column.key,
              value = d[key];
          return {
            column: column,
            row: d,
            key: key,
            value: value,
            string: column.format(value)
          };
        });
      })
      .text(function(d) { return d.string; });
  }

  function getFormData() {
    var data = {};
    inputs.each(function() {
      if (this.disabled || this.value === "") return;
      data[this.name] = this.value;
    });
    return data;
  }

  function setFormData(data) {
    if (!data) return;
    inputs.each(function() {
      if (data.hasOwnProperty(this.name)) {
        this.value = data[this.name];
      }
    });
  }

  function showError(error) {
    alert(error);
  }

  function getFormat(spec) {
    if (!spec) return function(d) { return d; };

    var index = spec.indexOf("%");
    if (index === -1) {
      return d3.format(spec);
    }
    var prefix = spec.substr(0, index),
        format = d3.format(spec.substr(index + 1));
    return function(str) {
      if (!str) return "";
      return prefix + format(+str);
    };
  }

})(this);
</script>

{% endblock %}
