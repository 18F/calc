{% extends 'data_capture/step.html' %}

{% block body_class %}secondary-step{% endblock %}

{% block subtitle %}Verify data{% endblock %}

{% block step_body %}
<form method="post">
  {% csrf_token %}

<h2>Verify vendor and contract details</h2>

<div data-edit-contract-details {% if not show_edit_form %}style="display: none"{% endif %}>

  {{ step_1_form.non_field_errors }}
  {{ step_2_form.non_field_errors }}

  {# TODO: Maybe reuse view logic from steps 1 and 2 here to stay DRY? #}

  {% load frontend %}

  {% with form=step_1_form %}
    {# TODO: It'd be nice if we could just eliminate this field. #}
    <div style="display: none">{% fieldset form.schedule %}</div>

    {% fieldset form.contract_number %}
    {% fieldset form.vendor_name %}
  {% endwith %}

  {% with form=step_2_form %}
    {% fieldset form.is_small_business %}
    {% fieldset form.contractor_site %}

    <div class="date-range {% if form.contract_start.errors or form.contract_end.errors%}fieldset-error{% endif %}">
      {% fieldset form.contract_start %}
      <p>to</p>
      {% fieldset form.contract_end %}
    </div>

    {% fieldset form.escalation_rate %}
  {% endwith %}

  <div class="form-button-row clearfix">
    <div class="submit-group">
      <button type="submit" class="button" name="save-changes">Save changes</button>
    </div>

    {# TODO: This should include any existing querystring args. #}

    <a type="submit" href="?">Discard changes</a>
  </div>

</div>

{% if not show_edit_form %}
<div data-contract-details>
<div class="row">
  <dl class="contract-details columns eight">
    <dt>Schedule</dt>
    <dd>{{ gleaned_data.title }}</dd>

    <dt>Contract number</dt>
    <dd>{{ price_list.contract_number }}</dd>

    <dt>Vendor</dt>
    <dd>{{ price_list.vendor_name }}</dd>

    <dt>Small business</dt>
    <dd>{% if price_list.is_small_business == 'True' %}Yes{% else %}No{% endif %}</dd>

    <dt>Contractor worksite</dt>
    <dd>{{ price_list.contractor_site }}</dd>

    <dt>Contract dates</dt>
    <dd class="contract-details__start-date">{{ price_list.contract_start }}</dd>
    <dd>{{ price_list.contract_end }}</dd>

    <dt>Escalation rate</dt>
    <dd>{{ price_list.escalation_rate }}%</dd>
  </dl>
</div>

{# TODO: This should include any existing querystring args. #}

<p><a href="?show_edit_form=on" class="button" data-edit-btn>Edit</a></p>
</div>
{% endif %}

{% if not is_preferred_schedule %}
  <div class="row">
    <div class="columns eight">
      <div class="alert alert-warning">
        <p>
          <strong>Note:</strong> You specified that the price list you were
          uploading was for <em>{{ preferred_schedule_title }}</em>, but it
          appears to be for <em>{{ gleaned_data.title }}</em>. If this is
          incorrect, please upload a different file.
        </p>
      </div>
    </div>
  </div>
{% endif %}

<br>

{% with rows=gleaned_data.valid_rows %}
  {% with total=rows|length %}
    <h2>Verify {{ total }} row{{ total|pluralize }} of data </h2>
  {% endwith %}

  {{ gleaned_data.to_table|safe }}
{% endwith %}

  <div class="form-button-row clearfix">
    {% if prev_url %}
      <a href="{{ prev_url }}" class="button button-previous">Previous</a>
    {% elif gleaned_data.invalid_rows %}
      <a href="{% url 'data_capture:step_3_errors' %}" class="button button-previous">Previous</a>
    {% else %}
      <a href="{% url 'data_capture:step_3' %}" class="button button-previous">Previous</a>
    {% endif %}

    {% if gleaned_data.valid_rows %}
      <div class="submit-group">
        {% if show_edit_form %}
          <button type="submit" class="button-primary">Save and submit for review</button>
          <span class="submit-label">
            Save changes and submit price list data to an administrator for approval.
          </span>
        {% else %}
          <button type="submit" class="button-primary" data-edit-text="Save and submit for review">Submit for review</button>
          <span class="submit-label" data-edit-text="Save changes and submit price list data to an administrator for approval.">
            Submit price list data to an administrator for approval.
          </span>
        {% endif %}
      </div>
    {% endif %}

    <button type="submit" class="button-link" name="cancel" data-a11y-dialog-show="cancel-dialog" formnovalidate>Cancel</button>
  </div>
</form>

{% if not is_safe_mode_enabled and not show_edit_form %}
<script>
$(function() {
  var editBtn = $('[data-edit-btn]');
  var contractDetails = $("[data-contract-details]");
  var editContractDetails = $("[data-edit-contract-details]");

  if (editBtn.length && contractDetails.length &&
      editContractDetails.length) {
    editBtn.click(function(e) {
      contractDetails.slideUp();
      editContractDetails.slideDown();
      $('[data-edit-text]').each(function() {
        $(this).text($(this).attr('data-edit-text'));
      });
      e.preventDefault();
    });
  } else {
    console.log(
      "Warning! Couldn't find edit button and/or related elements, " +
      "falling back to baseline behavior."
    );
  }
});
</script>
{% endif %}

{% endblock %}
